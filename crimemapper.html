<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Graph</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-size: 12px;
            transition: background-color 0.3s, color 0.3s;
        }
        body.light-mode {
            background-color: #f0f2f5;
            color: #1f2a44;
        }
        body.dark-mode {
            background-color: #1e293b;
            color: #e2e8f0;
        }
        #controls {
            width: 300px;
            border-radius: 8px 0 0 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            flex-shrink: 0;
            transition: background-color 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .light-mode #controls {
            background-color: #fff;
        }
        .dark-mode #controls {
            background-color: #2d3748;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        #myNetwork {
            flex-grow: 1;
            height: 100%;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }
        .light-mode #myNetwork {
            background-color: #fff;
        }
        .dark-mode #myNetwork {
            background-color: #334155;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #d1d5db;
            transition: border-color 0.3s;
            padding-top: 40px;
        }
        .dark-mode .tab-buttons {
            border-bottom: 1px solid #4b5563;
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 12px;
        }
        .light-mode .tab-button {
            background-color: #f9fafb;
            color: #1f2a44;
        }
        .dark-mode .tab-button {
            background-color: #374151;
            color: #e2e8f0;
        }
        .tab-button.active {
            font-weight: bold;
        }
        .light-mode .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #3b82f6;
        }
        .dark-mode .tab-button.active {
            background-color: #2d3748;
            border-bottom: 2px solid #60a5fa;
        }
        .light-mode .tab-button:hover:not(.active) {
            background-color: #e5e7eb;
        }
        .dark-mode .tab-button:hover:not(.active) {
            background-color: #4b5563;
        }
        .tab-content {
            padding: 15px;
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        .light-mode .input-group {
            background-color: #f9fafb;
        }
        .dark-mode .input-group {
            background-color: #374151;
        }
        .input-group h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
        }
        .light-mode .input-group h3 {
            color: #1f2a44;
        }
        .dark-mode .input-group h3 {
            color: #e2e8f0;
        }
        input, select {
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        .light-mode input, .light-mode select {
            border: 1px solid #d1d5db;
            background-color: #fff;
            color: #1f2a44;
        }
        .dark-mode input, .dark-mode select {
            border: 1px solid #4b5563;
            background-color: #4b5563;
            color: #e2e8f0;
        }
        input:focus, select:focus {
            outline: none;
        }
        .light-mode input:focus, .light-mode select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .dark-mode input:focus, .dark-mode select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            width: 100%;
            margin: 4px 0;
        }
        .light-mode button {
            background-color: #3b82f6;
            color: white;
        }
        .dark-mode button {
            background-color: #60a5fa;
            color: #1e293b;
        }
        .light-mode button:hover {
            background-color: #2563eb;
        }
        .dark-mode button:hover {
            background-color: #3b82f6;
        }
        .light-mode button:active {
            background-color: #1d4ed8;
        }
        .dark-mode button:active {
            background-color: #2563eb;
        }
        #mode-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #mode-toggle:hover {
            background-color: #4b5563;
        }
        #footer {
            text-align: center;
            padding: 10px;
            font-size: 10px;
            margin-top: auto;
            transition: color 0.3s;
        }
        .light-mode #footer {
            color: #6b7280;
        }
        .dark-mode #footer {
            color: #94a3b8;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
</head>
<body class="dark-mode">
    <div id="controls">
        <button id="mode-toggle" onclick="toggleMode()">Switch to Light Mode</button>
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('object-management')">Object Management</button>
            <button class="tab-button" onclick="showTab('link-management')">Link Management</button>
            <button class="tab-button" onclick="showTab('import-export')">Import/Export</button>
        </div>
        <div id="object-management" class="tab-content active">
            <div class="input-group">
                <h3>Add Entity</h3>
                <select id="entityType">
                    <option value="contact">Contact</option>
                    <option value="ip">IP Address</option>
                    <option value="domain">Domain</option>
                    <option value="organization">Organization</option>
                    <option value="port">Port</option>
                    <option value="wallet">Wallet</option>
                    <option value="bank">Bank Account</option>
                </select>
                <input type="text" id="nameInput" placeholder="Name">
                <input type="email" id="emailInput" placeholder="Email">
                <input type="text" id="ipInput" placeholder="IP Address" style="display: none;">
                <input type="text" id="domainInput" placeholder="Domain" style="display: none;">
                <input type="text" id="orgInput" placeholder="Organization Name" style="display: none;">
                <input type="text" id="portNumInput" placeholder="Port Number" style="display: none;">
                <select id="portType" style="display: none;">
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                </select>
                <input type="text" id="walletAddressInput" placeholder="Wallet Address" style="display: none;">
                <input type="text" id="accountNumberInput" placeholder="Account Number" style="display: none;">
                <input type="text" id="sortCodeInput" placeholder="Sort Code" style="display: none;">
                <button onclick="addNode()">Add Entity</button>
            </div>
            <div class="input-group">
                <h3>Edit Entity</h3>
                <select id="editNode" onchange="loadNodeData()"></select>
                <input type="text" id="editNameInput" placeholder="Name" style="display: none;">
                <input type="email" id="editEmailInput" placeholder="Email" style="display: none;">
                <input type="text" id="editIpInput" placeholder="IP Address" style="display: none;">
                <input type="text" id="editDomainInput" placeholder="Domain" style="display: none;">
                <input type="text" id="editOrgInput" placeholder="Organization Name" style="display: none;">
                <input type="text" id="editPortNumInput" placeholder="Port Number" style="display: none;">
                <select id="editPortType" style="display: none;">
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                </select>
                <input type="text" id="editWalletAddressInput" placeholder="Wallet Address" style="display: none;">
                <input type="text" id="editAccountNumberInput" placeholder="Account Number" style="display: none;">
                <input type="text" id="editSortCodeInput" placeholder="Sort Code" style="display: none;">
                <button onclick="saveNodeEdit()">Save Changes</button>
            </div>
            <div class="input-group">
                <h3>Remove Entity</h3>
                <select id="removeNode"></select>
                <button onclick="removeNode()">Remove Entity</button>
            </div>
        </div>
        <div id="link-management" class="tab-content">
            <div class="input-group">
                <h3>Create Link</h3>
                <select id="fromNode"></select>
                <select id="toNode"></select>
                <input type="text" id="edgeLabel" placeholder="Link Label">
                <button onclick="addEdge()">Add Link</button>
            </div>
            <div class="input-group">
                <h3>Remove Link</h3>
                <select id="removeEdge"></select>
                <button onclick="removeEdge()">Remove Link</button>
            </div>
        </div>
        <div id="import-export" class="tab-content">
            <div class="input-group">
                <h3>Export/Import</h3>
                <button onclick="exportGraph()">Export to JSON</button>
                <input type="file" id="importFile" accept=".json">
                <button onclick="importGraph()">Import from JSON</button>
                <button onclick="clearGraph()">Clear Graph</button>
            </div>
        </div>
        <div id="footer">
            © Xservus Limited - v0.1
        </div>
    </div>
    <div id="myNetwork"></div>

    <script>
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);
        let nextId = 1;
        let isDarkMode = true;

        // Create the network
        let container = document.getElementById('myNetwork');
        let data = { nodes: nodes, edges: edges };
        let options = {
            nodes: {
                shape: 'circle',
                size: 20,
                font: { 
                    size: 12,
                    align: 'center'
                },
                labelHighlightBold: false,
                scaling: {
                    min: 20,
                    max: 100,
                    label: { enabled: false }
                },
                margin: {
                    top: -30
                }
            },
            edges: {
                arrows: 'to',
                font: {
                    size: 14,
                    align: 'horizontal',
                    color: '#000000',
                    strokeWidth: 2,
                    strokeColor: '#ffffff'
                },
                color: {
                    color: '#6b7280',
                    highlight: '#3b82f6'
                }
            },
            physics: { enabled: true }
        };
        let network = new vis.Network(container, data, options);

        function updateTheme() {
            if (isDarkMode) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                document.getElementById('mode-toggle').textContent = 'Switch to Light Mode';
                options.nodes.font.color = '#e2e8f0';
                options.nodes.color = { border: '#e2e8f0' };
                options.edges.font.color = '#e2e8f0';
                options.edges.font.strokeColor = '#000000';
                options.edges.color = { color: '#94a3b8', highlight: '#60a5fa' };
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.getElementById('mode-toggle').textContent = 'Switch to Dark Mode';
                options.nodes.font.color = '#1f2a44';
                options.nodes.color = { border: '#000000' };
                options.edges.font.color = '#1f2a44';
                options.edges.font.strokeColor = '#ffffff';
                options.edges.color = { color: '#6b7280', highlight: '#3b82f6' };
            }
            network.setOptions(options);
            nodes.forEach(node => nodes.update({ id: node.id }));
            edges.forEach(edge => edges.update({ id: edge.id }));
        }

        function toggleMode() {
            isDarkMode = !isDarkMode;
            updateTheme();
        }

        updateTheme();

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        document.getElementById('entityType').addEventListener('change', function() {
            let type = this.value;
            document.getElementById('nameInput').style.display = type === 'contact' ? 'block' : 'none';
            document.getElementById('emailInput').style.display = type === 'contact' ? 'block' : 'none';
            document.getElementById('ipInput').style.display = type === 'ip' ? 'block' : 'none';
            document.getElementById('domainInput').style.display = type === 'domain' ? 'block' : 'none';
            document.getElementById('orgInput').style.display = type === 'organization' ? 'block' : 'none';
            document.getElementById('portNumInput').style.display = type === 'port' ? 'block' : 'none';
            document.getElementById('portType').style.display = type === 'port' ? 'block' : 'none';
            document.getElementById('walletAddressInput').style.display = type === 'wallet' ? 'block' : 'none';
            document.getElementById('accountNumberInput').style.display = type === 'bank' ? 'block' : 'none';
            document.getElementById('sortCodeInput').style.display = type === 'bank' ? 'block' : 'none';
        });

        function addNode() {
            let type = document.getElementById('entityType').value;
            let nodeData = { 
                id: nextId,
                size: 20,
                type: type
            };

            if (type === 'contact') {
                let name = document.getElementById('nameInput').value;
                let email = document.getElementById('emailInput').value;
                if (!name || !email) {
                    alert('Please enter both name and email for contacts');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'contact' && node.name === name && node.email === email }).length > 0) {
                    alert('A contact with this name and email already exists');
                    return;
                }
                nodeData.label = `${name}\n${email}`;
                nodeData.title = `Contact\nName: ${name}\nEmail: ${email}`;
                nodeData.color = { background: '#4ade80' };
                nodeData.name = name;
                nodeData.email = email;
            } else if (type === 'ip') {
                let ip = document.getElementById('ipInput').value;
                if (!ip) {
                    alert('Please enter an IP address');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'ip' && node.ip === ip }).length > 0) {
                    alert('This IP address already exists');
                    return;
                }
                nodeData.label = ip;
                nodeData.title = `IP Address: ${ip}`;
                nodeData.color = { background: '#f87171' };
                nodeData.ip = ip;
            } else if (type === 'domain') {
                let domain = document.getElementById('domainInput').value;
                if (!domain) {
                    alert('Please enter a domain');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'domain' && node.domain === domain }).length > 0) {
                    alert('This domain already exists');
                    return;
                }
                nodeData.label = domain;
                nodeData.title = `Domain: ${domain}`;
                nodeData.color = { background: '#60a5fa' };
                nodeData.domain = domain;
            } else if (type === 'organization') {
                let org = document.getElementById('orgInput').value;
                if (!org) {
                    alert('Please enter an organization name');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'organization' && node.organization === org }).length > 0) {
                    alert('This organization already exists');
                    return;
                }
                nodeData.label = org;
                nodeData.title = `Organization: ${org}`;
                nodeData.color = { background: '#facc15' };
                nodeData.organization = org;
            } else if (type === 'port') {
                let portNum = document.getElementById('portNumInput').value;
                let portType = document.getElementById('portType').value;
                if (!portNum) {
                    alert('Please enter a port number');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'port' && node.portNumber === portNum && node.portType === portType }).length > 0) {
                    alert('This port (type and number) already exists');
                    return;
                }
                nodeData.label = `${portType}/${portNum}`;
                nodeData.title = `Port\nType: ${portType}\nNumber: ${portNum}`;
                nodeData.color = { background: '#a78bfa' };
                nodeData.portType = portType;
                nodeData.portNumber = portNum;
            } else if (type === 'wallet') {
                let address = document.getElementById('walletAddressInput').value;
                if (!address) {
                    alert('Please enter a wallet address');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'wallet' && node.address === address }).length > 0) {
                    alert('This wallet address already exists');
                    return;
                }
                nodeData.label = address;
                nodeData.title = `Wallet\nAddress: ${address}`;
                nodeData.color = { background: '#fb923c' };
                nodeData.address = address;
            } else if (type === 'bank') {
                let accountNumber = document.getElementById('accountNumberInput').value;
                let sortCode = document.getElementById('sortCodeInput').value;
                if (!accountNumber || !sortCode) {
                    alert('Please enter both account number and sort code for bank account');
                    return;
                }
                if (nodes.get({ filter: node => node.type === 'bank' && node.accountNumber === accountNumber && node.sortCode === sortCode }).length > 0) {
                    alert('This bank account (account number and sort code) already exists');
                    return;
                }
                nodeData.label = `${accountNumber}\n${sortCode}`;
                nodeData.title = `Bank Account\nAccount Number: ${accountNumber}\nSort Code: ${sortCode}`;
                nodeData.color = { background: '#10b981' };
                nodeData.accountNumber = accountNumber;
                nodeData.sortCode = sortCode;
            }

            nodes.add(nodeData);
            updateSelectOptions();
            clearInputs();
            nextId++;
        }

        function loadNodeData() {
            let nodeId = document.getElementById('editNode').value;
            let node = nodes.get(parseInt(nodeId));
            if (!node) {
                clearEditInputs();
                return;
            }

            document.getElementById('editNameInput').style.display = 'none';
            document.getElementById('editEmailInput').style.display = 'none';
            document.getElementById('editIpInput').style.display = 'none';
            document.getElementById('editDomainInput').style.display = 'none';
            document.getElementById('editOrgInput').style.display = 'none';
            document.getElementById('editPortNumInput').style.display = 'none';
            document.getElementById('editPortType').style.display = 'none';
            document.getElementById('editWalletAddressInput').style.display = 'none';
            document.getElementById('editAccountNumberInput').style.display = 'none';
            document.getElementById('editSortCodeInput').style.display = 'none';

            if (node.type === 'contact') {
                document.getElementById('editNameInput').value = node.name || '';
                document.getElementById('editEmailInput').value = node.email || '';
                document.getElementById('editNameInput').style.display = 'block';
                document.getElementById('editEmailInput').style.display = 'block';
            } else if (node.type === 'ip') {
                document.getElementById('editIpInput').value = node.ip || '';
                document.getElementById('editIpInput').style.display = 'block';
            } else if (node.type === 'domain') {
                document.getElementById('editDomainInput').value = node.domain || '';
                document.getElementById('editDomainInput').style.display = 'block';
            } else if (node.type === 'organization') {
                document.getElementById('editOrgInput').value = node.organization || '';
                document.getElementById('editOrgInput').style.display = 'block';
            } else if (node.type === 'port') {
                document.getElementById('editPortNumInput').value = node.portNumber || '';
                document.getElementById('editPortType').value = node.portType || 'TCP';
                document.getElementById('editPortNumInput').style.display = 'block';
                document.getElementById('editPortType').style.display = 'block';
            } else if (node.type === 'wallet') {
                document.getElementById('editWalletAddressInput').value = node.address || '';
                document.getElementById('editWalletAddressInput').style.display = 'block';
            } else if (node.type === 'bank') {
                document.getElementById('editAccountNumberInput').value = node.accountNumber || '';
                document.getElementById('editSortCodeInput').value = node.sortCode || '';
                document.getElementById('editAccountNumberInput').style.display = 'block';
                document.getElementById('editSortCodeInput').style.display = 'block';
            }
        }

        function saveNodeEdit() {
            let nodeId = document.getElementById('editNode').value;
            if (!nodeId) {
                alert('Please select a node to edit');
                return;
            }

            let node = nodes.get(parseInt(nodeId));
            let updatedData = { id: parseInt(nodeId), type: node.type };

            if (node.type === 'contact') {
                let name = document.getElementById('editNameInput').value;
                let email = document.getElementById('editEmailInput').value;
                if (!name || !email) {
                    alert('Please enter both name and email for contacts');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'contact' && n.name === name && n.email === email && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('Another contact with this name and email already exists');
                    return;
                }
                updatedData.label = `${name}\n${email}`;
                updatedData.title = `Contact\nName: ${name}\nEmail: ${email}`;
                updatedData.color = { background: '#4ade80' };
                updatedData.name = name;
                updatedData.email = email;
            } else if (node.type === 'ip') {
                let ip = document.getElementById('editIpInput').value;
                if (!ip) {
                    alert('Please enter an IP address');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'ip' && n.ip === ip && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This IP address already exists');
                    return;
                }
                updatedData.label = ip;
                updatedData.title = `IP Address: ${ip}`;
                updatedData.color = { background: '#f87171' };
                updatedData.ip = ip;
            } else if (node.type === 'domain') {
                let domain = document.getElementById('editDomainInput').value;
                if (!domain) {
                    alert('Please enter a domain');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'domain' && n.domain === domain && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This domain already exists');
                    return;
                }
                updatedData.label = domain;
                updatedData.title = `Domain: ${domain}`;
                updatedData.color = { background: '#60a5fa' };
                updatedData.domain = domain;
            } else if (node.type === 'organization') {
                let org = document.getElementById('editOrgInput').value;
                if (!org) {
                    alert('Please enter an organization name');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'organization' && n.organization === org && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This organization already exists');
                    return;
                }
                updatedData.label = org;
                updatedData.title = `Organization: ${org}`;
                updatedData.color = { background: '#facc15' };
                updatedData.organization = org;
            } else if (node.type === 'port') {
                let portNum = document.getElementById('editPortNumInput').value;
                let portType = document.getElementById('editPortType').value;
                if (!portNum) {
                    alert('Please enter a port number');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'port' && n.portNumber === portNum && n.portType === portType && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This port (type and number) already exists');
                    return;
                }
                updatedData.label = `${portType}/${portNum}`;
                updatedData.title = `Port\nType: ${portType}\nNumber: ${portNum}`;
                updatedData.color = { background: '#a78bfa' };
                updatedData.portType = portType;
                updatedData.portNumber = portNum;
            } else if (node.type === 'wallet') {
                let address = document.getElementById('editWalletAddressInput').value;
                if (!address) {
                    alert('Please enter a wallet address');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'wallet' && n.address === address && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This wallet address already exists');
                    return;
                }
                updatedData.label = address;
                updatedData.title = `Wallet\nAddress: ${address}`;
                updatedData.color = { background: '#fb923c' };
                updatedData.address = address;
            } else if (node.type === 'bank') {
                let accountNumber = document.getElementById('editAccountNumberInput').value;
                let sortCode = document.getElementById('editSortCodeInput').value;
                if (!accountNumber || !sortCode) {
                    alert('Please enter both account number and sort code for bank account');
                    return;
                }
                if (nodes.get({ filter: n => n.type === 'bank' && n.accountNumber === accountNumber && n.sortCode === sortCode && n.id !== parseInt(nodeId) }).length > 0) {
                    alert('This bank account (account number and sort code) already exists');
                    return;
                }
                updatedData.label = `${accountNumber}\n${sortCode}`;
                updatedData.title = `Bank Account\nAccount Number: ${accountNumber}\nSort Code: ${sortCode}`;
                updatedData.color = { background: '#10b981' };
                updatedData.accountNumber = accountNumber;
                updatedData.sortCode = sortCode;
            }

            nodes.update(updatedData);
            updateSelectOptions();
            updateEdgeSelectOptions();
            clearEditInputs();
        }

        function clearEditInputs() {
            document.getElementById('editNameInput').value = '';
            document.getElementById('editEmailInput').value = '';
            document.getElementById('editIpInput').value = '';
            document.getElementById('editDomainInput').value = '';
            document.getElementById('editOrgInput').value = '';
            document.getElementById('editPortNumInput').value = '';
            document.getElementById('editWalletAddressInput').value = '';
            document.getElementById('editAccountNumberInput').value = '';
            document.getElementById('editSortCodeInput').value = '';
            document.getElementById('editNode').value = '';
            document.getElementById('editNameInput').style.display = 'none';
            document.getElementById('editEmailInput').style.display = 'none';
            document.getElementById('editIpInput').style.display = 'none';
            document.getElementById('editDomainInput').style.display = 'none';
            document.getElementById('editOrgInput').style.display = 'none';
            document.getElementById('editPortNumInput').style.display = 'none';
            document.getElementById('editPortType').style.display = 'none';
            document.getElementById('editWalletAddressInput').style.display = 'none';
            document.getElementById('editAccountNumberInput').style.display = 'none';
            document.getElementById('editSortCodeInput').style.display = 'none';
        }

        function addEdge() {
            let from = document.getElementById('fromNode').value;
            let to = document.getElementById('toNode').value;
            let label = document.getElementById('edgeLabel').value;
            if (from && to && from !== to) {
                const edgeId = `edge_${from}_${to}_${Date.now()}`;
                edges.add({ 
                    id: edgeId,
                    from: parseInt(from), 
                    to: parseInt(to),
                    label: label || undefined
                });
                updateNodeSizes();
                updateEdgeSelectOptions();
                network.setData({ nodes: nodes, edges: edges });
                document.getElementById('edgeLabel').value = '';
            } else {
                alert('Please select different nodes to create a link');
            }
        }

        function removeNode() {
            let nodeId = document.getElementById('removeNode').value;
            if (nodeId) {
                let connectedEdges = edges.get({
                    filter: edge => edge.from === parseInt(nodeId) || edge.to === parseInt(nodeId)
                });
                connectedEdges.forEach(edge => edges.remove(edge.id));
                nodes.remove({ id: parseInt(nodeId) });
                updateNodeSizes();
                updateSelectOptions();
                updateEdgeSelectOptions();
                network.setData({ nodes: nodes, edges: edges });
            } else {
                alert('Please select a node to remove');
            }
        }

        function removeEdge() {
            let edgeId = document.getElementById('removeEdge').value;
            if (edgeId) {
                edges.remove({ id: edgeId });
                updateNodeSizes();
                updateEdgeSelectOptions();
                network.setData({ nodes: nodes, edges: edges });
                document.getElementById('removeEdge').selectedIndex = 0;
            } else {
                alert('Please select an edge to remove');
            }
        }

        function clearGraph() {
            if (confirm('Are you sure you want to clear the graph? This will remove all nodes and edges.')) {
                nodes.clear();
                edges.clear();
                nextId = 1; // Reset ID counter
                updateNodeSizes();
                updateSelectOptions();
                updateEdgeSelectOptions();
                network.setData({ nodes: nodes, edges: edges });
                clearInputs();
            }
        }

        function updateNodeSizes() {
            nodes.forEach(node => {
                let connections = edges.get({
                    filter: edge => edge.from === node.id || edge.to === node.id
                }).length;
                nodes.update({
                    id: node.id,
                    size: 20 + connections * 10
                });
            });
        }

        function updateSelectOptions() {
            let fromSelect = document.getElementById('fromNode');
            let toSelect = document.getElementById('toNode');
            let removeSelect = document.getElementById('removeNode');
            let editSelect = document.getElementById('editNode');
            fromSelect.innerHTML = '<option value="">Select From</option>';
            toSelect.innerHTML = '<option value="">Select To</option>';
            removeSelect.innerHTML = '<option value="">Select Node</option>';
            editSelect.innerHTML = '<option value="">Select Node</option>';
            
            nodes.forEach(node => {
                let option = document.createElement('option');
                option.value = node.id;
                option.text = node.label.split('\n')[0];
                fromSelect.appendChild(option.cloneNode(true));
                toSelect.appendChild(option.cloneNode(true));
                removeSelect.appendChild(option.cloneNode(true));
                editSelect.appendChild(option.cloneNode(true));
            });
        }

        function updateEdgeSelectOptions() {
            let removeEdgeSelect = document.getElementById('removeEdge');
            removeEdgeSelect.innerHTML = '<option value="">Select Edge</option>';
            
            edges.forEach(edge => {
                let fromNode = nodes.get(edge.from);
                let toNode = nodes.get(edge.to);
                if (fromNode && toNode) {
                    let option = document.createElement('option');
                    option.value = edge.id;
                    option.text = `${fromNode.label.split('\n')[0]} -> ${toNode.label.split('\n')[0]}${edge.label ? ' (' + edge.label + ')' : ''}`;
                    removeEdgeSelect.appendChild(option);
                }
            });
        }

        function clearInputs() {
            document.getElementById('nameInput').value = '';
            document.getElementById('emailInput').value = '';
            document.getElementById('ipInput').value = '';
            document.getElementById('domainInput').value = '';
            document.getElementById('orgInput').value = '';
            document.getElementById('portNumInput').value = '';
            document.getElementById('walletAddressInput').value = '';
            document.getElementById('accountNumberInput').value = '';
            document.getElementById('sortCodeInput').value = '';
        }

        function exportGraph() {
            const exportData = {
                nodes: nodes.get().map(node => ({
                    id: node.id,
                    type: node.type,
                    name: node.name,
                    email: node.email,
                    ip: node.ip,
                    domain: node.domain,
                    organization: node.organization,
                    portType: node.portType,
                    portNumber: node.portNumber,
                    address: node.address,
                    accountNumber: node.accountNumber,
                    sortCode: node.sortCode
                })),
                edges: edges.get().map(edge => ({
                    id: edge.id,
                    from: edge.from,
                    to: edge.to,
                    label: edge.label
                }))
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'network_graph.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function importGraph() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a JSON file to import');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    nodes.clear();
                    edges.clear();

                    importedData.nodes.forEach(node => {
                        let nodeData = {
                            id: node.id,
                            size: 20,
                            type: node.type
                        };

                        if (node.type === 'contact') {
                            nodeData.label = `${node.name}\n${node.email}`;
                            nodeData.title = `Contact\nName: ${node.name}\nEmail: ${node.email}`;
                            nodeData.color = { background: '#4ade80' };
                            nodeData.name = node.name;
                            nodeData.email = node.email;
                        } else if (node.type === 'ip') {
                            nodeData.label = node.ip;
                            nodeData.title = `IP Address: ${node.ip}`;
                            nodeData.color = { background: '#f87171' };
                            nodeData.ip = node.ip;
                        } else if (node.type === 'domain') {
                            nodeData.label = node.domain;
                            nodeData.title = `Domain: ${node.domain}`;
                            nodeData.color = { background: '#60a5fa' };
                            nodeData.domain = node.domain;
                        } else if (node.type === 'organization') {
                            nodeData.label = node.organization;
                            nodeData.title = `Organization: ${node.organization}`;
                            nodeData.color = { background: '#facc15' };
                            nodeData.organization = node.organization;
                        } else if (node.type === 'port') {
                            nodeData.label = `${node.portType}/${node.portNumber}`;
                            nodeData.title = `Port\nType: ${node.portType}\nNumber: ${node.portNumber}`;
                            nodeData.color = { background: '#a78bfa' };
                            nodeData.portType = node.portType;
                            nodeData.portNumber = node.portNumber;
                        } else if (node.type === 'wallet') {
                            nodeData.label = node.address;
                            nodeData.title = `Wallet\nAddress: ${node.address}`;
                            nodeData.color = { background: '#fb923c' };
                            nodeData.address = node.address;
                        } else if (node.type === 'bank') {
                            nodeData.label = `${node.accountNumber}\n${node.sortCode}`;
                            nodeData.title = `Bank Account\nAccount Number: ${node.accountNumber}\nSort Code: ${node.sortCode}`;
                            nodeData.color = { background: '#10b981' };
                            nodeData.accountNumber = node.accountNumber;
                            nodeData.sortCode = node.sortCode;
                        }

                        let isDuplicate = false;
                        if (node.type === 'contact') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'contact' && n.name === nodeData.name && n.email === nodeData.email }).length > 0;
                        } else if (node.type === 'ip') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'ip' && n.ip === nodeData.ip }).length > 0;
                        } else if (node.type === 'domain') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'domain' && n.domain === nodeData.domain }).length > 0;
                        } else if (node.type === 'organization') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'organization' && n.organization === nodeData.organization }).length > 0;
                        } else if (node.type === 'port') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'port' && n.portNumber === nodeData.portNumber && n.portType === nodeData.portType }).length > 0;
                        } else if (node.type === 'wallet') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'wallet' && n.address === nodeData.address }).length > 0;
                        } else if (node.type === 'bank') {
                            isDuplicate = nodes.get({ filter: n => n.type === 'bank' && n.accountNumber === nodeData.accountNumber && n.sortCode === nodeData.sortCode }).length > 0;
                        }

                        if (!isDuplicate) {
                            nodes.add(nodeData);
                        }
                    });

                    importedData.edges.forEach(edge => {
                        edges.add({ 
                            id: edge.id || `edge_${edge.from}_${edge.to}_${Date.now()}`,
                            from: edge.from, 
                            to: edge.to,
                            label: edge.label || undefined
                        });
                    });

                    updateNodeSizes();
                    updateSelectOptions();
                    updateEdgeSelectOptions();
                    network.setData({ nodes: nodes, edges: edges });
                    nextId = Math.max(...importedData.nodes.map(n => n.id)) + 1;

                    fileInput.value = '';
                } catch (e) {
                    alert('Error importing JSON: ' + e.message);
                }
            };
            reader.readAsText(file);
        }

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                addNode();
            }
        });
    </script>
</body>
</html>
